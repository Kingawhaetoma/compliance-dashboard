// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum AssessmentStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETE
}

enum ControlStatus {
  NOT_APPLICABLE
  NOT_IMPLEMENTED
  PARTIALLY_IMPLEMENTED
  IMPLEMENTED
}

enum EngagementStatus {
  ACTIVE
  PAUSED
  CLOSED
}

enum ResponseReviewStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  REJECTED
  NEEDS_INFO
}

enum EvidenceReviewStatus {
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  REJECTED
  NEEDS_INFO
}

enum POAMStatus {
  OPEN
  IN_PROGRESS
  BLOCKED
  DONE
}

enum POAMSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum EvidenceSourceType {
  URL
  FILE
}

enum EvidenceStatus {
  COLLECTED
  PENDING_REVIEW
  APPROVED
  REJECTED
}

enum AuditFindingSeverity {
  LOW
  MEDIUM
  HIGH
}

enum AuditFindingStatus {
  OPEN
  RESOLVED
}

enum AuditActivityAction {
  CONTROL_STATUS_CHANGED
  CONTROL_OWNER_ASSIGNED
  EVIDENCE_ADDED
  ASSESSMENT_COMPLETED
  FINDING_CREATED
  FINDING_RESOLVED
}

model Organization {
  id                  String             @id @default(cuid())
  name                String             @unique
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  assessments         Assessment[]
  customerEngagements Engagement[]       @relation("CustomerOrgEngagements")
  vendorEngagements   Engagement[]       @relation("VendorOrgEngagements")
  auditFindings       AuditFinding[]
  auditActivityLogs   AuditActivityLog[]
}

model Framework {
  id        String    @id @default(cuid())
  key       String    @unique // e.g., HIPAA, NIST, SOC2, ISO27001, CIS
  name      String
  version   String?
  createdAt DateTime  @default(now())
  controls  Control[]
}

model Control {
  id          String   @id @default(cuid())
  frameworkId String
  code        String // e.g., "164.310(d)(1)" or "PR.AC-1"
  title       String
  description String?
  domain      String? // optional grouping
  createdAt   DateTime @default(now())

  framework         Framework          @relation(fields: [frameworkId], references: [id])
  evidence          Evidence[]
  findings          Finding[]
  responses         ControlResponse[]
  auditFindings     AuditFinding[]
  auditActivityLogs AuditActivityLog[]
}

model Assessment {
  id             String           @id @default(cuid())
  organizationId String
  engagementId   String?
  name           String
  status         AssessmentStatus @default(NOT_STARTED)
  startDate      DateTime?
  endDate        DateTime?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  organization      Organization       @relation(fields: [organizationId], references: [id])
  engagement        Engagement?        @relation(fields: [engagementId], references: [id])
  findings          Finding[]
  controlResponses  ControlResponse[]
  auditFindings     AuditFinding[]
  auditActivityLogs AuditActivityLog[]
}

model Finding {
  id           String        @id @default(cuid())
  assessmentId String
  controlId    String
  status       ControlStatus @default(NOT_IMPLEMENTED)
  notes        String?
  risk         String? // Low/Med/High text for demo
  owner        String?
  dueDate      DateTime?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  assessment    Assessment     @relation(fields: [assessmentId], references: [id])
  control       Control        @relation(fields: [controlId], references: [id])
  evidenceLinks EvidenceLink[]
}

model Evidence {
  id            String             @id @default(cuid())
  controlId     String
  title         String
  description   String?
  url           String? // link to doc/screenshot/etc
  sourceType    EvidenceSourceType @default(URL)
  status        EvidenceStatus     @default(COLLECTED)
  fileName      String?
  mimeType      String?
  fileSizeBytes Int?
  storagePath   String?
  uploadedBy    String?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @default(now()) @updatedAt

  control           Control            @relation(fields: [controlId], references: [id])
  links             EvidenceLink[]
  auditActivityLogs AuditActivityLog[]

  @@index([controlId])
  @@index([status])
  @@index([sourceType])
}

model EvidenceLink {
  id         String @id @default(cuid())
  findingId  String
  evidenceId String

  finding  Finding  @relation(fields: [findingId], references: [id])
  evidence Evidence @relation(fields: [evidenceId], references: [id])

  @@unique([findingId, evidenceId])
}

model Engagement {
  id            String           @id @default(cuid())
  customerOrgId String
  vendorOrgId   String
  name          String
  status        EngagementStatus @default(ACTIVE)
  startDate     DateTime?
  dueDate       DateTime?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  customerOrg Organization @relation("CustomerOrgEngagements", fields: [customerOrgId], references: [id])
  vendorOrg   Organization @relation("VendorOrgEngagements", fields: [vendorOrgId], references: [id])
  assessments Assessment[]

  @@unique([customerOrgId, vendorOrgId, name])
  @@index([customerOrgId])
  @@index([vendorOrgId])
}

model ControlResponse {
  id            String               @id @default(cuid())
  assessmentId  String
  controlId     String
  status        ControlStatus        @default(NOT_IMPLEMENTED)
  reviewStatus  ResponseReviewStatus @default(DRAFT)
  risk          String?
  owner         String?
  vendorNotes   String?
  reviewerNotes String?
  dueDate       DateTime?
  submittedAt   DateTime?
  reviewedAt    DateTime?
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt

  assessment          Assessment           @relation(fields: [assessmentId], references: [id])
  control             Control              @relation(fields: [controlId], references: [id])
  evidenceSubmissions EvidenceSubmission[]
  poamItems           POAMItem[]

  @@unique([assessmentId, controlId])
  @@index([assessmentId])
  @@index([controlId])
}

model EvidenceSubmission {
  id                String               @id @default(cuid())
  controlResponseId String
  title             String
  url               String?
  description       String?
  submittedBy       String?
  reviewStatus      EvidenceReviewStatus @default(SUBMITTED)
  reviewerComment   String?
  reviewedBy        String?
  submittedAt       DateTime             @default(now())
  reviewedAt        DateTime?
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt

  controlResponse ControlResponse @relation(fields: [controlResponseId], references: [id])

  @@index([controlResponseId])
  @@index([reviewStatus])
}

model POAMItem {
  id                String       @id @default(cuid())
  controlResponseId String
  title             String
  description       String?
  status            POAMStatus   @default(OPEN)
  severity          POAMSeverity @default(MEDIUM)
  owner             String?
  dueDate           DateTime?
  closedAt          DateTime?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  controlResponse ControlResponse @relation(fields: [controlResponseId], references: [id])

  @@index([controlResponseId])
  @@index([status])
  @@index([severity])
}

model AuditFinding {
  id             String               @id @default(cuid())
  organizationId String?
  assessmentId   String?
  controlId      String?
  title          String
  severity       AuditFindingSeverity @default(MEDIUM)
  status         AuditFindingStatus   @default(OPEN)
  recommendation String
  details        String?
  owner          String?
  resolvedAt     DateTime?
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @default(now()) @updatedAt

  organization      Organization?      @relation(fields: [organizationId], references: [id])
  assessment        Assessment?        @relation(fields: [assessmentId], references: [id])
  control           Control?           @relation(fields: [controlId], references: [id])
  auditActivityLogs AuditActivityLog[]

  @@index([organizationId])
  @@index([assessmentId])
  @@index([controlId])
  @@index([status])
  @@index([severity])
}

model AuditActivityLog {
  id             String              @id @default(cuid())
  action         AuditActivityAction
  message        String
  actor          String?
  metadata       Json?
  organizationId String?
  assessmentId   String?
  controlId      String?
  evidenceId     String?
  auditFindingId String?
  createdAt      DateTime            @default(now())

  organization Organization? @relation(fields: [organizationId], references: [id])
  assessment   Assessment?   @relation(fields: [assessmentId], references: [id])
  control      Control?      @relation(fields: [controlId], references: [id])
  evidence     Evidence?     @relation(fields: [evidenceId], references: [id])
  auditFinding AuditFinding? @relation(fields: [auditFindingId], references: [id])

  @@index([action])
  @@index([createdAt])
  @@index([organizationId])
  @@index([assessmentId])
  @@index([controlId])
  @@index([evidenceId])
  @@index([auditFindingId])
}
